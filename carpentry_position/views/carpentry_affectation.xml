<?xml version="1.0" encoding="utf-8" ?>
<odoo>
    <!-- Tree (Phase) -->
    <record id="carpentry_affectation_tree_phase" model="ir.ui.view">
        <field name="name">carpentry.affectation.tree.phase</field>
        <field name="model">carpentry.affectation</field>

        <field name="arch" type="xml">
            <tree editable="bottom" delete="False" limit="200">
                <field name="project_id" invisible="1" />
                <field name="is_affectable" invisible="1" />
                <field name="mode" invisible="1" />

                <field name="lot_id"      options="{'no_create': 1}" />
                <field name="position_id" options="{'no_create': 1}" decoration-bf="True" />
                <field name="quantity_position" />
                <field name="quantity_remaining_to_affect"
                    decoration-success="quantity_remaining_to_affect &gt; 0"
                    decoration-bf     ="quantity_remaining_to_affect &gt; 0"
                />
                <field name="quantity_affected"
                    attrs="{
                        'required': [('mode', '=', 'phase')],
                        'readonly': ['|', ('mode', '=', 'launch'), ('is_affectable', '=', False)],
                    }"
                    sum="1" 
                    decoration-primary="quantity_affected &gt; 0"
                    decoration-bf     ="quantity_affected &gt; 0"
                />
                <button icon="fa-ban" attrs="{'invisible': [('is_affectable', '=', True)]}" title="Already affected" />
            </tree>
        </field>
    </record>
    <!-- Tree (Launch) -->
    <record id="carpentry_affectation_tree_launch" model="ir.ui.view">
        <field name="name">carpentry.affectation.tree.launch</field>
        <field name="model">carpentry.affectation</field>
        <field name="inherit_id" ref="carpentry_position.carpentry_affectation_tree_phase" />
        <field name="mode">primary</field>
        <field name="priority">10000</field>

        <field name="arch" type="xml">
            <field name="lot_id" position="attributes">
                <attribute name="name">phase_id</attribute>
            </field>

            <field name="quantity_position" position="replace" />
            <field name="quantity_remaining_to_affect" position="replace" />
            
            <button position="before">
                <field name="affected" widget="boolean_toggle" attrs="{
                    'readonly': [('is_affectable', '=', False), ('affected', '=', False)],
                }" />
            </button>
        </field>
    </record>

    <!-- Form -->
    <record id="carpentry_affectation_form" model="ir.ui.view">
        <field name="name">carpentry.affectation.form</field>
        <field name="model">carpentry.affectation</field>

        <field name="arch" type="xml">
            <form>
                <field name="mode" invisible="1" />

                <sheet>
                    <group name="group_left">
                        <group name="group_left">
                            <field name="project_id" />
                            <field name="position_id" />
                            <field name="launch_id" attrs="{'invisible': [('mode', '!=', 'launch')]}" />
                            <field name="phase_id" />
                            
                            <field name="lot_id" attrs="{'invisible': [('mode', '!=', 'phase')]}" />
                        </group>

                        <group name="group_right">
                            <field name="quantity_affected" readonly="1" />
                            <field name="quantity_position" />
                            <field name="quantity_remaining_to_affect" />
                        </group>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    
    <!-- Search -->
    <record model="ir.ui.view" id="carpentry_affectation_search">
        <field name="name">carpentry.affectation.search</field>
        <field name="model">carpentry.affectation</field>

        <field name="arch" type="xml">
            <search>
                <field name="project_id" />

                <filter string="â˜… Projects"
                    name="my_favorite_projects"
                    domain="[('project_id.favorite_user_ids','=',uid)]"
                />

                <searchpanel>
                    <field name="project_id" invisible="context.get('default_project_id')" />
                </searchpanel>
            </search>
        </field>
    </record>
</odoo>
